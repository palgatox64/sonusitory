{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonusitory</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <meta name="csrf-token" content="{{ csrf_token }}">
    <script>
        document.body.addEventListener('htmx:configRequest', function(event) {
            if (event.detail.verb === 'post') {
                const token = document.querySelector('meta[name="csrf-token"]').content;
                event.detail.headers['X-CSRFToken'] = token;
            }
        });
    </script>
    <link rel="icon" type="image/png" href="{% static 'images/favicon.png' %}">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    {% block extra_head %}{% endblock %}
</head>
<body>

    <nav style="padding: 1rem 2rem; background-color: #181818; border-bottom: 1px solid #282828; display: flex; justify-content: space-between; align-items: center;">
        
        {% if request.resolver_match.url_name == 'login' or request.resolver_match.url_name == 'register' %}
            <img src="{% static 'images/sonusitory_with_icon.png' %}" alt="Sonusitory" style="height: 40px;">
        {% else %}
            <a href="{% url 'artist_list' %}"
                hx-get="{% url 'artist_list' %}"
                hx-target=".main-content"
                hx-push-url="true">
                <img src="{% static 'images/sonusitory_with_icon.png' %}" alt="Sonusitory" style="height: 40px;">
            </a>
        {% endif %}
        
        <div>
            {% if user.is_authenticated %}
                <div class="dropdown">
                    <button class="dropdown-toggle-btn" id="user-menu-toggle">
                        <img src="{% if user.userprofile and user.userprofile.avatar_url %}{{ user.userprofile.avatar_url }}{% else %}{% static 'images/default_avatar.jpg' %}{% endif %}" alt="Menú de usuario" class="user-avatar">
                    </button>
                    <div class="dropdown-menu" id="user-menu">
                        <a href="{% url 'account' %}" hx-get="{% url 'account' %}" hx-target=".main-content" hx-push-url="true" class="btn">Cuenta</a>
                        <form action="{% url 'logout' %}" method="post" style="margin: 0;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger">
                                Cerrar Sesión
                            </button>
                        </form>
                    </div>
                </div>

            {% else %}
                {% if request.resolver_match.url_name != 'login' %}
                    <a href="{% url 'login' %}" style="margin-right: 1rem;" class="btn">Iniciar Sesión</a>
                {% endif %}

                {% if request.resolver_match.url_name != 'register' %}
                    <a href="{% url 'register' %}" class="btn">Registrarse</a>
                {% endif %}
            {% endif %}
        </div>
    </nav>

    <div class="main-content">
        {% block content %}{% endblock %}
    </div>

    <div id="player-wrapper">
        {% block player %}
        <div class="persistent-player">
            <p id="now-playing">Selecciona una canción</p>
            <audio id="main-audio-player" controls preload="none"></audio>
        </div>
        {% endblock %}
    </div>

    {% block extra_scripts %}
    <script>
    
    let songQueue = [];
    let songMenuListenersInitialized = false;

    function playSong(songId, songName) {
        const songUrl = `/play/${songId}/`;
        const nowPlayingElem = document.getElementById('now-playing');
        const audioPlayer = document.getElementById('main-audio-player');
        
        if (nowPlayingElem && audioPlayer) {
            nowPlayingElem.textContent = `Reproduciendo: ${songName}`;
            audioPlayer.src = songUrl;
            audioPlayer.load();
            audioPlayer.play().catch(e => console.error("Error al reproducir:", e));
        }
    }

    function initializeAvatarUpload() {
        const changeAvatarButton = document.getElementById('change-avatar-button');
        if (!changeAvatarButton) return;

        const avatarInput = document.getElementById('avatar-input');
        const avatarPreview = document.getElementById('avatar-preview');
        let originalAvatarSrc = avatarPreview.src; 

        changeAvatarButton.addEventListener('click', () => {
            originalAvatarSrc = avatarPreview.src; 
            avatarInput.click();
        });

        avatarInput.addEventListener('change', () => {
            const file = avatarInput.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                avatarPreview.src = e.target.result;
                Swal.fire({
                    title: "¿Quieres guardar este cambio?",
                    imageUrl: e.target.result,
                    imageHeight: 150,
                    imageAlt: 'Previsualización',
                    showCancelButton: true,
                    confirmButtonText: "Guardar",
                    cancelButtonText: "Cancelar",
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                }).then((result) => {
                    if (result.isConfirmed) {
                        const formData = new FormData();
                        formData.append('avatar', file);
                        const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
                        Swal.fire({ title: 'Subiendo...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

                        fetch("{% url 'upload_avatar' %}", {
                            method: 'POST',
                            body: formData,
                            headers: { 'X-CSRFToken': csrfToken }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.avatar_url) {
                                avatarPreview.src = data.avatar_url;
                                const userAvatarInNav = document.querySelector('.user-avatar');
                                if (userAvatarInNav) userAvatarInNav.src = data.avatar_url;
                                Swal.fire('¡Guardado!', 'Tu nueva foto de perfil ha sido guardada.', 'success');
                            } else {
                                Swal.fire('¡Error!', data.error || 'No se pudo subir la imagen.', 'error');
                                avatarPreview.src = originalAvatarSrc;
                            }
                        })
                        .catch(() => {
                            Swal.fire('¡Error!', 'Ocurrió un error de red.', 'error');
                            avatarPreview.src = originalAvatarSrc;
                        });

                    } else {
                        avatarPreview.src = originalAvatarSrc;
                        Swal.fire("Cancelado", "Tu foto de perfil no ha cambiado.", "info");
                    }
                });
            };
            reader.readAsDataURL(file);
            avatarInput.value = '';
        });
    }

    function updateUserMenuVisibility() {
        const userMenuDropdown = document.querySelector('.dropdown');
        if (userMenuDropdown) {
            if (window.location.pathname === '/account/') {
                userMenuDropdown.style.display = 'none';
            } else {
                userMenuDropdown.style.display = 'inline-block';
            }
        }
    }

    function initializeAccountButtonListener() {
        const accountUnlinkButton = document.getElementById('account-unlink-button');
        if (accountUnlinkButton) {
            accountUnlinkButton.addEventListener('click', function(event) {
                event.preventDefault(); 
                const hasCredentials = event.target.dataset.hasCredentials === 'true';

                if (hasCredentials) {
                    Swal.fire({
                        title: '¿Estás seguro?',
                        text: "Se borrarán todos tus datos de la librería (canciones, álbumes, artistas) y se desvinculará tu nube. ¡Pero puedes volver a vincular tu nube más tarde!",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#3085d6',
                        confirmButtonText: 'Sí, ¡bórralo todo!',
                        cancelButtonText: 'Cancelar'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = event.target.href;
                        }
                    });
                } else {
                    Swal.fire({
                        title: '¡No hay nada que desvincular!',
                        text: 'Actualmente no tienes ninguna cuenta de nube vinculada.',
                        icon: 'info',
                        confirmButtonText: 'Entendido'
                    });
                }
            });
        }
    }


    function initializeSongMenuListeners() {
        if (songMenuListenersInitialized) return;
        songMenuListenersInitialized = true;
        
        document.body.addEventListener('click', function(event) {
            const menuButton = event.target.closest('.song-menu-btn');
            
            if (menuButton) {
                event.preventDefault();
                event.stopPropagation();

                const parentLi = menuButton.closest('li');
                const dropdown = menuButton.nextElementSibling;
                const isAlreadyOpen = parentLi.classList.contains('menu-open');

                // Cerrar todos los menús abiertos
                document.querySelectorAll('#song-list li.menu-open').forEach(openLi => {
                    openLi.classList.remove('menu-open');
                    const menuDropdown = openLi.querySelector('.song-menu-dropdown');
                    const menuBtn = openLi.querySelector('.song-menu-btn');
                    if (menuDropdown) menuDropdown.classList.remove('show');
                    if (menuBtn) menuBtn.classList.remove('is-visible');
                });

                if (!isAlreadyOpen) {
                    parentLi.classList.add('menu-open');
                    dropdown.classList.add('show');
                    menuButton.classList.add('is-visible');
                }
                return;
            }


            const queueButton = event.target.closest('.queue-add-btn');
            if (queueButton) {
                event.stopPropagation();
                const songId = queueButton.dataset.songId;
                const songName = queueButton.dataset.songName;
                
                if (songId && songName) {
                    songQueue.push({ id: songId, name: songName });

                    const Toast = Swal.mixin({
                        toast: true, position: 'top-end', showConfirmButton: false, timer: 3500, timerProgressBar: true,
                        didOpen: (toast) => {
                            toast.onmouseenter = Swal.stopTimer;
                            toast.onmouseleave = Swal.resumeTimer;
                        }
                    });
                    Toast.fire({ icon: 'success', title: `'${songName}' añadida a la cola` });
                }
                return;
            }

            const songItem = event.target.closest('li[data-song-id]');
            if (songItem && !event.target.closest('.song-menu-container')) {
                const songId = songItem.dataset.songId;
                const songName = songItem.dataset.songName;
                if (songId && songName) {
                    playSong(songId, songName);
                }
            }

            // Manejar clicks en botones de "Me Gusta"
            const likeButton = event.target.closest('.like-btn');
            if (likeButton) {
                event.stopPropagation();
                const songId = likeButton.dataset.songId;
                const songName = likeButton.closest('li').dataset.songName;
                const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
                const songLi = likeButton.closest('li');
                const isInLikedSongsPage = window.location.pathname === '/liked/' || window.location.pathname.includes('/liked/');
                
                fetch(`/toggle-like/${songId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.liked !== undefined) {
                        const Toast = Swal.mixin({
                            toast: true, 
                            position: 'top-end', 
                            showConfirmButton: false, 
                            timer: 3000, 
                            timerProgressBar: true,
                            didOpen: (toast) => {
                                toast.onmouseenter = Swal.stopTimer;
                                toast.onmouseleave = Swal.resumeTimer;
                            }
                        });
                        
                        if (data.liked) {
                            likeButton.classList.add('liked');
                            Toast.fire({ 
                                icon: 'success', 
                                title: `'${songName}' añadida a tus Me Gusta` 
                            });
                        } else {
                            likeButton.classList.remove('liked');
                            Toast.fire({ 
                                icon: 'info', 
                                title: `'${songName}' eliminada de tus Me Gusta` 
                            });
                            
                            if (isInLikedSongsPage && songLi) {
                                songLi.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                                songLi.style.opacity = '0';
                                songLi.style.transform = 'translateX(-20px)';
                                
                                setTimeout(() => {
                                    songLi.remove();
                                    
                                    const songList = document.getElementById('song-list');
                                    if (songList && songList.children.length === 0) {
                                        songList.style.display = 'none';
                                        
                                        const emptyMessage = document.createElement('p');
                                        emptyMessage.textContent = 'No tienes canciones marcadas como "Me gusta" aún.';
                                        songList.parentNode.insertBefore(emptyMessage, songList.nextSibling);
                                    }
                                }, 300);
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    const Toast = Swal.mixin({
                        toast: true, 
                        position: 'top-end', 
                        showConfirmButton: false, 
                        timer: 3000, 
                        timerProgressBar: true
                    });
                    Toast.fire({ 
                        icon: 'error', 
                        title: 'Error al procesar Me Gusta' 
                    });
                });
                return;
            }

            if (!event.target.closest('.song-menu-container')) {
                document.querySelectorAll('#song-list li.menu-open').forEach(openLi => {
                    openLi.classList.remove('menu-open');
                    const menuDropdown = openLi.querySelector('.song-menu-dropdown');
                    const menuBtn = openLi.querySelector('.song-menu-btn');
                    if (menuDropdown) menuDropdown.classList.remove('show');
                    if (menuBtn) menuBtn.classList.remove('is-visible');
                });
            }
        });
    }

    window.addEventListener('click', function(event) {

        if (!event.target.closest('.song-menu-container')) {
            document.querySelectorAll('#song-list li.menu-open').forEach(openLi => {
                openLi.classList.remove('menu-open');
                const menuDropdown = openLi.querySelector('.song-menu-dropdown');
                const menuBtn = openLi.querySelector('.song-menu-btn');
                if (menuDropdown) menuDropdown.classList.remove('show');
                if (menuBtn) menuBtn.classList.remove('is-visible');
            });
        }

        const userMenu = document.getElementById('user-menu');
        if (userMenu && !event.target.closest('#user-menu-toggle')) {
            if (userMenu.classList.contains('show')) {
                userMenu.classList.remove('show');
            }
        }
    });


    document.addEventListener('DOMContentLoaded', function() {
        const audioPlayer = document.getElementById('main-audio-player');
        const nowPlayingElem = document.getElementById('now-playing');

        if (audioPlayer && nowPlayingElem) {
            audioPlayer.addEventListener('play', () => {
                const songList = document.getElementById('song-list');
                if (songList) songList.classList.add('playback-active');
            });

            audioPlayer.addEventListener('pause', () => {
                const songList = document.getElementById('song-list');
                if (songList) songList.classList.remove('playback-active');
            });

            audioPlayer.addEventListener('ended', () => {
                console.log('Canción terminada. Cola actual:', songQueue.map(song => song.name));
                if (songQueue.length > 0) {
                    const nextSong = songQueue.shift();
                    console.log('Reproduciendo siguiente:', nextSong.name);
                    playSong(nextSong.id, nextSong.name);
                } else {
                    const songList = document.getElementById('song-list');
                    if (songList) songList.classList.remove('playbook-active');
                    nowPlayingElem.textContent = 'Selecciona una canción';
                }
            });
        }

        updateUserMenuVisibility();
        initializeAccountButtonListener();
        initializeAvatarUpload();
        initializeSongMenuListeners();
        
        const userMenuToggle = document.getElementById('user-menu-toggle');
        const userMenu = document.getElementById('user-menu');

        if (userMenuToggle) {
            userMenuToggle.addEventListener('click', function(event) {
                event.stopPropagation();
                userMenu.classList.toggle('show');
            });
        }


    });

    document.body.addEventListener('htmx:beforeRequest', function(event) {
        if (event.detail.elt.id !== 'scan-button' && event.detail.elt.id !== 'quick-scan-button' && event.detail.elt.id !== 'cover-scan-button') {
            Swal.fire({
                title: 'Cargando...',
                allowOutsideClick: false,
                showConfirmButton: false,
                didOpen: () => Swal.showLoading()
            });
        }
    });

    document.body.addEventListener('htmx:afterRequest', function(event) {
        Swal.close();
        if ((event.detail.elt.id === 'scan-button' || event.detail.elt.id === 'quick-scan-button' || event.detail.elt.id === 'cover-scan-button') && event.detail.xhr.status === 200) {
            const response = JSON.parse(event.detail.xhr.responseText);
            const taskId = response.task_id;
            if (taskId) pollTaskStatus(taskId);
        }
    });

    document.body.addEventListener('htmx:afterOnLoad', function() {
        updateUserMenuVisibility();
        initializeAccountButtonListener();
        initializeAvatarUpload();
        
        const audioPlayer = document.getElementById('main-audio-player');
        const songList = document.getElementById('song-list');
        if (audioPlayer && songList && !audioPlayer.paused) {
            songList.classList.add('playback-active');
        }
    });

    function pollTaskStatus(taskId) {
        Swal.fire({
            title: 'Iniciando escaneo...',
            text: 'Por favor, espera.',
            allowOutsideClick: false,
            showConfirmButton: false,
            didOpen: () => Swal.showLoading()
        });

        const interval = setInterval(() => {
            fetch(`/task-status/${taskId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'PROGRESS') {
                        let title = 'Escaneando tu librería...';
                        let progressText = 'Preparando...';

                        if (data.info && data.info.step) {
                            if (data.info.step === 'finding_folders') {
                                title = 'Analizando estructura...';
                                progressText = 'Buscando todas las carpetas en tu nube. Esto puede tardar...';
                            } else if (data.info.step === 'folders_found') {
                                title = 'Análisis de estructura completo';
                                progressText = `Se encontraron ${data.info.total_folders} carpetas. Iniciando siguiente paso...`;
                            } else if (data.info.step === 'identifying_album_folders') {
                                title = 'Identificando Álbumes';
                                progressText = 'Determinando qué carpetas contienen música.';
                            } else if (data.info.step === 'songs') {
                                title = 'Paso 1 de 2: Procesando canciones...';
                                progressText = `Procesando lote ${data.info.current} de ${data.info.total}`;
                            } else if (data.info.step === 'covers') {
                                title = 'Paso 2 de 2: Buscando portadas...';
                                progressText = `Analizando carpeta de álbum ${data.info.current} de ${data.info.total}`;
                            }
                        }
                        Swal.update({ title, text: progressText });
                        Swal.showLoading();

                    } else if (data.status === 'SUCCESS') {
                        clearInterval(interval);
                        Swal.fire({
                            title: '¡Éxito!', text: data.info, icon: 'success', confirmButtonText: 'Ir a mi librería'
                        }).then(() => {
                            window.location.href = "{% url 'artist_list' %}";
                        });
                    } else if (data.status === 'FAILURE') {
                        clearInterval(interval);
                        Swal.fire({
                            title: '¡Error!', text: 'Ocurrió un error durante el escaneo.', icon: 'error', confirmButtonText: 'Entendido'
                        });
                    }
                })
                .catch(error => {
                    clearInterval(interval);
                    Swal.fire('Error de conexión', 'No se pudo obtener el estado del escaneo.', 'error');
                });
        }, 3000);
    }

    window.showQueue = function() {
        console.log('Cola actual:', songQueue.map(song => song.name));
    };
    </script>
    {% endblock %}

</body>
</html>