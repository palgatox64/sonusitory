{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonusitory</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <meta name="csrf-token" content="{{ csrf_token }}">
    <script>
        document.body.addEventListener('htmx:configRequest', function(event) {
            if (event.detail.verb === 'post') {
                const token = document.querySelector('meta[name="csrf-token"]').content;
                event.detail.headers['X-CSRFToken'] = token;
            }
        });
    </script>
    <link rel="icon" type="image/png" href="{% static 'images/favicon.png' %}">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    {% block extra_head %}{% endblock %}
</head>
<body>

    <nav style="padding: 1rem 2rem; background-color: #181818; border-bottom: 1px solid #282828; display: flex; justify-content: space-between; align-items: center;">

        {% if request.resolver_match.url_name == 'login' or request.resolver_match.url_name == 'register' %}
            <img src="{% static 'images/sonusitory_with_icon.png' %}" alt="Sonusitory" style="height: 40px;">
        {% else %}
            <a href="{% url 'artist_list' %}"
                hx-get="{% url 'artist_list' %}"
                hx-target=".main-content"
                hx-push-url="true">
                <img src="{% static 'images/sonusitory_with_icon.png' %}" alt="Sonusitory" style="height: 40px;">
            </a>
        {% endif %}

        <div>
            {% if user.is_authenticated %}
                <div class="dropdown">
                    <button class="dropdown-toggle-btn" id="user-menu-toggle">
                        <img src="{% if user.userprofile and user.userprofile.avatar_url %}{{ user.userprofile.avatar_url }}{% else %}{% static 'images/default_avatar.jpg' %}{% endif %}" alt="Menú de usuario" class="user-avatar">
                    </button>
                    <div class="dropdown-menu" id="user-menu">
                        <a href="{% url 'account' %}" hx-get="{% url 'account' %}" hx-target=".main-content" hx-push-url="true" class="btn">Cuenta</a>
                        <form action="{% url 'logout' %}" method="post" style="margin: 0;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger">
                                Cerrar Sesión
                            </button>
                        </form>
                    </div>
                </div>

            {% else %}
                {% if request.resolver_match.url_name != 'login' %}
                    <a href="{% url 'login' %}" style="margin-right: 1rem;" class="btn">Iniciar Sesión</a>
                {% endif %}

                {% if request.resolver_match.url_name != 'register' %}
                    <a href="{% url 'register' %}" class="btn">Registrarse</a>
                {% endif %}
            {% endif %}
        </div>
    </nav>

    <div class="main-content">
        {% block content %}{% endblock %}
    </div>

    <div id="player-wrapper">
        {% block player %}
        <div class="persistent-player">
            <p id="now-playing">Selecciona una canción</p>
            <audio id="main-audio-player" controls preload="none"></audio>
        </div>
        {% endblock %}
    </div>

    {% block extra_scripts %}
    <script>

    let songQueue = [];
    let songMenuListenersInitialized = false;

    function playSong(songId, songName) {
        const songUrl = `/play/${songId}/`;
        const nowPlayingElem = document.getElementById('now-playing');
        const audioPlayer = document.getElementById('main-audio-player');

        if (nowPlayingElem && audioPlayer) {
            nowPlayingElem.textContent = `Reproduciendo: ${songName}`;
            audioPlayer.src = songUrl;
            audioPlayer.load();
            audioPlayer.play().catch(e => console.error("Error al reproducir:", e));
        }
    }

    function initializeAvatarUpload() {
        const changeAvatarButton = document.getElementById('change-avatar-button');
        if (!changeAvatarButton) return;

        const avatarInput = document.getElementById('avatar-input');
        const avatarPreview = document.getElementById('avatar-preview');
        let originalAvatarSrc = avatarPreview.src;

        // Remover event listeners previos para evitar duplicados
        changeAvatarButton.replaceWith(changeAvatarButton.cloneNode(true));
        const newChangeAvatarButton = document.getElementById('change-avatar-button');

        newChangeAvatarButton.addEventListener('click', () => {
            originalAvatarSrc = avatarPreview.src;
            avatarInput.click();
        });

        // También remover y recrear el event listener del input
        avatarInput.replaceWith(avatarInput.cloneNode(true));
        const newAvatarInput = document.getElementById('avatar-input');

        newAvatarInput.addEventListener('change', () => {
            const file = newAvatarInput.files[0];
            if (!file) return;

            // Validar tipo de archivo
            if (!file.type.startsWith('image/')) {
                Swal.fire('Error', 'Por favor selecciona un archivo de imagen válido.', 'error');
                return;
            }

            // Validar tamaño de archivo (máximo 5MB)
            if (file.size > 5 * 1024 * 1024) {
                Swal.fire('Error', 'La imagen es demasiado grande. Máximo 5MB.', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                avatarPreview.src = e.target.result;
                Swal.fire({
                    title: "¿Quieres guardar este cambio?",
                    imageUrl: e.target.result,
                    imageHeight: 150,
                    imageAlt: 'Previsualización',
                    showCancelButton: true,
                    confirmButtonText: "Guardar",
                    cancelButtonText: "Cancelar",
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                }).then((result) => {
                    if (result.isConfirmed) {
                        const formData = new FormData();
                        formData.append('avatar', file);
                        const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
                        Swal.fire({ title: 'Subiendo...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

                        fetch("{% url 'upload_avatar' %}", {
                            method: 'POST',
                            body: formData,
                            headers: { 'X-CSRFToken': csrfToken }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.avatar_url) {
                                avatarPreview.src = data.avatar_url;
                                const userAvatarInNav = document.querySelector('.user-avatar');
                                if (userAvatarInNav) userAvatarInNav.src = data.avatar_url;
                                Swal.fire('¡Guardado!', 'Tu nueva foto de perfil ha sido guardada.', 'success');
                            } else {
                                Swal.fire('¡Error!', data.error || 'No se pudo subir la imagen.', 'error');
                                avatarPreview.src = originalAvatarSrc;
                            }
                        })
                        .catch(() => {
                            Swal.fire('¡Error!', 'Ocurrió un error de red.', 'error');
                            avatarPreview.src = originalAvatarSrc;
                        });

                    } else {
                        avatarPreview.src = originalAvatarSrc;
                        Swal.fire("Cancelado", "Tu foto de perfil no ha cambiado.", "info");
                    }
                });
            };
            reader.readAsDataURL(file);
            newAvatarInput.value = '';
        });
    }

    function updateUserMenuVisibility() {
        const userMenuDropdown = document.querySelector('.dropdown');
        if (userMenuDropdown) {
            if (window.location.pathname === '/account/') {
                userMenuDropdown.style.display = 'none';
            } else {
                userMenuDropdown.style.display = 'inline-block';
            }
        }
    }

    function initializeAccountButtonListener() {
        const accountUnlinkButton = document.getElementById('account-unlink-button');
        if (accountUnlinkButton) {
            accountUnlinkButton.addEventListener('click', function(event) {
                event.preventDefault();
                const hasCredentials = event.target.dataset.hasCredentials === 'true';

                if (hasCredentials) {
                    Swal.fire({
                        title: '¿Estás seguro?',
                        text: "Se borrarán todos tus datos de la librería (canciones, álbumes, artistas) y se desvinculará tu nube. ¡Pero puedes volver a vincular tu nube más tarde!",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#3085d6',
                        confirmButtonText: 'Sí, ¡bórralo todo!',
                        cancelButtonText: 'Cancelar'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = event.target.href;
                        }
                    });
                } else {
                    Swal.fire({
                        title: '¡No hay nada que desvincular!',
                        text: 'Actualmente no tienes ninguna cuenta de nube vinculada.',
                        icon: 'info',
                        confirmButtonText: 'Entendido'
                    });
                }
            });
        }
    }

    function openPlaylistModal(songId, songName) {
        // Obtener las playlists del usuario
        fetch('/get-user-playlists/')
            .then(response => response.json())
            .then(playlists => {
                let playlistOptions = '';
                
                if (playlists.length === 0) {
                    playlistOptions = '<p style="text-align: center; color: #b3b3b3; margin: 20px 0;">No tienes playlists creadas. <br><a href="/playlists/" style="color: #bb86fc;">Crear una nueva playlist</a></p>';
                } else {
                    playlistOptions = playlists.map(playlist => 
                        `<div class="playlist-option" 
                              style="display: flex; align-items: center; gap: 15px; padding: 15px; background-color: #383838; margin-bottom: 10px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s ease;"
                              data-playlist-id="${playlist.id}"
                              onmouseover="this.style.backgroundColor='#484848'"
                              onmouseout="this.style.backgroundColor='#383838'">
                            <img src="${playlist.cover_image_url || '/static/images/default_cover.png'}" 
                                 alt="${playlist.name}" 
                                 style="width: 50px; height: 50px; border-radius: 5px; object-fit: cover;">
                            <div>
                                <div style="color: #ffffff; font-weight: 600;">${playlist.name}</div>
                                <div style="color: #b3b3b3; font-size: 0.9rem;">${playlist.song_count} canción${playlist.song_count !== 1 ? 'es' : ''}</div>
                            </div>
                        </div>`
                    ).join('');
                }

                Swal.fire({
                    title: 'Añadir a playlist',
                    html: `
                        <div style="text-align: left;">
                            <p style="margin-bottom: 15px; color: #e0e0e0;">Selecciona una playlist para "${songName}":</p>
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${playlistOptions}
                            </div>
                        </div>
                    `,
                    showCancelButton: true,
                    showConfirmButton: false,
                    cancelButtonText: 'Cancelar',
                    didOpen: () => {
                        // Añadir event listeners a las opciones de playlist
                        document.querySelectorAll('.playlist-option').forEach(option => {
                            option.addEventListener('click', function() {
                                const playlistId = this.dataset.playlistId;
                                const playlistName = this.querySelector('div div').textContent;
                                
                                // Añadir canción a la playlist
                                addSongToPlaylist(songId, playlistId, songName, playlistName);
                                Swal.close();
                            });
                        });
                    }
                });
            })
            .catch(error => {
                console.error('Error obteniendo playlists:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudieron cargar las playlists'
                });
            });
    }

    function addSongToPlaylist(songId, playlistId, songName, playlistName) {
        // Obtener token CSRF
        let csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
        if (!csrfToken) {
            csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        }
        if (!csrfToken) {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') {
                    csrfToken = value;
                    break;
                }
            }
        }

        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', csrfToken);

        fetch(`/add-to-playlist/${songId}/${playlistId}/`, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true
                });
                Toast.fire({
                    icon: 'success',
                    title: `"${songName}" añadida a "${playlistName}"`
                });
            } else {
                throw new Error('Error al añadir a playlist');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'No se pudo añadir la canción a la playlist'
            });
        });
    }

    function initializeSongMenuListeners() {
        if (songMenuListenersInitialized) return;
        songMenuListenersInitialized = true;

        document.body.addEventListener('click', function(event) {
            const menuButton = event.target.closest('.song-menu-btn');

            if (menuButton) {
                event.preventDefault();
                event.stopPropagation();

                const parentLi = menuButton.closest('li');
                const dropdown = menuButton.nextElementSibling; // Debe ser .song-menu-dropdown
                const isAlreadyOpen = parentLi.classList.contains('menu-open');

                // Cerrar todos los menús abiertos
                document.querySelectorAll('#song-list li.menu-open').forEach(openLi => {
                    openLi.classList.remove('menu-open');
                    const menuDropdown = openLi.querySelector('.song-menu-dropdown');
                    const menuBtn = openLi.querySelector('.song-menu-btn');
                    if (menuDropdown) menuDropdown.classList.remove('show');
                    if (menuBtn) menuBtn.classList.remove('is-visible');
                });

                if (!isAlreadyOpen && dropdown) {
                    parentLi.classList.add('menu-open');
                    dropdown.classList.add('show');
                    menuButton.classList.add('is-visible');

                    // Verificar posición y ajustar si es necesario
                    setTimeout(() => {
                        const rect = dropdown.getBoundingClientRect();
                        const windowHeight = window.innerHeight;
                        const playerHeight = 120;

                        if (rect.bottom > windowHeight - playerHeight - 10) {
                            dropdown.classList.add('show-above');
                        } else {
                            dropdown.classList.remove('show-above');
                        }
                    }, 10);
                }
                return;
            }

            const addToPlaylistButton = event.target.closest('.add-to-playlist-btn');
            if (addToPlaylistButton) {
                event.stopPropagation();
                const songId = addToPlaylistButton.dataset.songId;
                const songName = addToPlaylistButton.dataset.songName;
                openPlaylistModal(songId, songName);
            }


            const queueButton = event.target.closest('.queue-add-btn');
            if (queueButton) {
                event.stopPropagation();
                const songId = queueButton.dataset.songId;
                const songName = queueButton.dataset.songName;

                if (songId && songName) {
                    songQueue.push({ id: songId, name: songName });

                    const Toast = Swal.mixin({
                        toast: true, position: 'top-end', showConfirmButton: false, timer: 3500, timerProgressBar: true,
                        didOpen: (toast) => {
                            toast.onmouseenter = Swal.stopTimer;
                            toast.onmouseleave = Swal.resumeTimer;
                        }
                    });
                    Toast.fire({ icon: 'success', title: `'${songName}' añadida a la cola` });
                }
                return;
            }

            const songItem = event.target.closest('li[data-song-id]');
            if (songItem && !event.target.closest('.song-menu-container')) {
                const songId = songItem.dataset.songId;
                const songName = songItem.dataset.songName;
                if (songId && songName) {
                    playSong(songId, songName);
                }
            }

            const likeButton = event.target.closest('.like-btn');
            if (likeButton) {
                event.stopPropagation();
                const songId = likeButton.dataset.songId;
                const songName = likeButton.closest('li').dataset.songName;
                const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
                const songLi = likeButton.closest('li');
                const isInLikedSongsPage = window.location.pathname === '/liked/' || window.location.pathname.includes('/liked/');

                const formData = new FormData();
                formData.append('csrfmiddlewaretoken', csrfToken);

                fetch(`/toggle-like/${songId}/`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.liked !== undefined) {
                        if (data.liked) {
                            likeButton.classList.add('liked');
                            const Toast = Swal.mixin({
                                toast: true,
                                position: 'top-end',
                                showConfirmButton: false,
                                timer: 3000,
                                timerProgressBar: true,
                                didOpen: (toast) => {
                                    toast.onmouseenter = Swal.stopTimer;
                                    toast.onmouseleave = Swal.resumeTimer;
                                }
                            });
                            Toast.fire({
                                icon: 'success',
                                title: `'${songName}' añadida a tus Me Gusta`
                            });
                        } else {
                            likeButton.classList.remove('liked');

                            const Toast = Swal.mixin({
                                toast: true,
                                position: 'top-end',
                                showConfirmButton: true,
                                confirmButtonText: 'Deshacer',
                                timer: 5000,
                                timerProgressBar: true,
                                didOpen: (toast) => {
                                    toast.onmouseenter = Swal.stopTimer;
                                    toast.onmouseleave = Swal.resumeTimer;
                                }
                            });

                            Toast.fire({
                                icon: 'info',
                                title: `'${songName}' eliminada de tus Me Gusta`
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    // Deshacer la acción - volver a dar like con fecha original
                                    const undoFormData = new FormData();
                                    undoFormData.append('csrfmiddlewaretoken', csrfToken);
                                    undoFormData.append('undo', 'true');
                                    undoFormData.append('original_date', data.original_date);

                                    fetch(`/toggle-like/${songId}/`, {
                                        method: 'POST',
                                        body: undoFormData
                                    })
                                    .then(response => response.json())
                                    .then(undoData => {
                                        if (undoData.liked) {
                                            likeButton.classList.add('liked');


                                            if (isInLikedSongsPage && !document.contains(songLi)) {
                                                window.location.reload();
                                            }


                                            const UndoToast = Swal.mixin({
                                                toast: true,
                                                position: 'top-end',
                                                showConfirmButton: false,
                                                timer: 2500,
                                                timerProgressBar: true
                                            });
                                            UndoToast.fire({
                                                icon: 'success',
                                                title: `'${songName}' restaurada a tus Me Gusta`
                                            });
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error al deshacer:', error);
                                        const ErrorToast = Swal.mixin({
                                            toast: true,
                                            position: 'top-end',
                                            showConfirmButton: false,
                                            timer: 3000,
                                            timerProgressBar: true
                                        });
                                        ErrorToast.fire({
                                            icon: 'error',
                                            title: 'Error al deshacer la acción'
                                        });
                                    });
                                }
                            });

                            if (isInLikedSongsPage && songLi) {
                                setTimeout(() => {
                                    if (!likeButton.classList.contains('liked')) {
                                        songLi.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                                        songLi.style.opacity = '0';
                                        songLi.style.transform = 'translateX(-20px)';

                                        setTimeout(() => {
                                            if (!likeButton.classList.contains('liked')) {
                                                songLi.remove();


                                                const songList = document.getElementById('song-list');
                                                if (songList && songList.children.length === 0) {
                                                    songList.style.display = 'none';

                                                    const emptyMessage = document.createElement('p');
                                                    emptyMessage.textContent = 'No tienes canciones marcadas como "Me gusta" aún.';
                                                    songList.parentNode.insertBefore(emptyMessage, songList.nextSibling);
                                                }
                                            }
                                        }, 300);
                                    }
                                }, 100);
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    const Toast = Swal.mixin({
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true
                    });
                    Toast.fire({
                        icon: 'error',
                        title: 'Error al procesar Me Gusta'
                    });
                });
                return;
            }

            if (!event.target.closest('.song-menu-container')) {
                document.querySelectorAll('#song-list li.menu-open').forEach(openLi => {
                    openLi.classList.remove('menu-open');
                    const menuDropdown = openLi.querySelector('.song-menu-dropdown');
                    const menuBtn = openLi.querySelector('.song-menu-btn');
                    if (menuDropdown) menuDropdown.classList.remove('show');
                    if (menuBtn) menuBtn.classList.remove('is-visible');
                });
            }
        });
    }

    function initializeUserMenuToggle() {
        const userMenuToggle = document.getElementById('user-menu-toggle');
        const userMenu = document.getElementById('user-menu');
        
        if (userMenuToggle && userMenu) {
            // Remover event listeners previos para evitar duplicados
            userMenuToggle.replaceWith(userMenuToggle.cloneNode(true));
            const newToggle = document.getElementById('user-menu-toggle');
            
            newToggle.addEventListener('click', function(event) {
                event.preventDefault();
                event.stopPropagation();
                
                // Toggle la visibilidad del menú
                userMenu.classList.toggle('show');
            });
            
            // Cerrar el menú cuando se hace clic fuera de él
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.dropdown')) {
                    userMenu.classList.remove('show');
                }
            });
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const audioPlayer = document.getElementById('main-audio-player');
        const nowPlayingElem = document.getElementById('now-playing');

        if (audioPlayer && nowPlayingElem) {
            audioPlayer.addEventListener('play', () => {
                const songList = document.getElementById('song-list');
                if (songList) songList.classList.add('playback-active');
            });

            audioPlayer.addEventListener('pause', () => {
                const songList = document.getElementById('song-list');
                if (songList) songList.classList.remove('playback-active');
            });

            audioPlayer.addEventListener('ended', () => {
                console.log('Canción terminada. Cola actual:', songQueue.map(song => song.name));
                if (songQueue.length > 0) {
                    const nextSong = songQueue.shift();
                    console.log('Reproduciendo siguiente:', nextSong.name);
                    playSong(nextSong.id, nextSong.name);
                } else {
                    const songList = document.getElementById('song-list');
                    if (songList) songList.classList.remove('playbook-active');
                    nowPlayingElem.textContent = 'Selecciona una canción';
                }
            });
        }

        updateUserMenuVisibility();
        initializeAccountButtonListener();
        initializeAvatarUpload();
        initializeSongMenuListeners();
        initializeCreatePlaylistButton();
        initializeUserMenuToggle();
    });

    function initializeCreatePlaylistButton() {
        const createPlaylistBtn = document.getElementById('create-playlist-btn');
        if (createPlaylistBtn) {
            // Remover event listeners previos para evitar duplicados
            createPlaylistBtn.replaceWith(createPlaylistBtn.cloneNode(true));
            const newBtn = document.getElementById('create-playlist-btn');
            
            newBtn.addEventListener('click', function() {
                Swal.fire({
                    title: 'Crear Nueva Playlist',
                    html: `
                        <div style="text-align: left;">
                            <label for="playlist-name" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Nombre de la playlist:</label>
                            <input type="text" id="playlist-name" class="swal2-input" placeholder="Ingresa el nombre..." style="margin-bottom: 1rem;">
                            
                            <label for="playlist-cover" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Imagen de portada (opcional):</label>
                            <input type="file" id="playlist-cover" accept="image/*" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            <small style="color: #666; display: block; margin-top: 0.5rem;">Si no seleccionas una imagen, se usará la portada por defecto.</small>
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Crear',
                    cancelButtonText: 'Cancelar',
                    preConfirm: () => {
                        const name = document.getElementById('playlist-name').value;
                        const coverFile = document.getElementById('playlist-cover').files[0];
                        
                        if (!name || name.trim() === '') {
                            Swal.showValidationMessage('Debes ingresar un nombre para la playlist');
                            return false;
                        }
                        
                        return { name: name.trim(), coverFile: coverFile };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        const { name, coverFile } = result.value;
                        
                        // Obtener el token CSRF de diferentes formas
                        let csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
                        if (!csrfToken) {
                            csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
                        }
                        if (!csrfToken) {
                            const cookies = document.cookie.split(';');
                            for (let cookie of cookies) {
                                const [cookieName, value] = cookie.trim().split('=');
                                if (cookieName === 'csrftoken') {
                                    csrfToken = value;
                                    break;
                                }
                            }
                        }
                        
                        // Mostrar loading si hay imagen
                        if (coverFile) {
                            Swal.fire({
                                title: 'Creando playlist...',
                                text: 'Subiendo imagen, por favor espera.',
                                allowOutsideClick: false,
                                showConfirmButton: false,
                                didOpen: () => Swal.showLoading()
                            });
                        }
                        
                        const formData = new FormData();
                        formData.append('csrfmiddlewaretoken', csrfToken);
                        formData.append('name', name);
                        if (coverFile) {
                            formData.append('cover_image', coverFile);
                        }
                        
                        fetch('{% url "create_playlist" %}', {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => {
                            if (response.ok) {
                                const Toast = Swal.mixin({
                                    toast: true,
                                    position: 'top-end',
                                    showConfirmButton: false,
                                    timer: 3000,
                                    timerProgressBar: true
                                });
                                Toast.fire({
                                    icon: 'success',
                                    title: `Playlist "${name}" creada exitosamente`
                                });
                                
                                // Recargar la lista de playlists via HTMX
                                htmx.ajax('GET', '{% url "playlist_list" %}', {
                                    target: '.main-content',
                                    swap: 'innerHTML'
                                });
                                
                            } else {
                                throw new Error('Error al crear la playlist');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'No se pudo crear la playlist'
                            });
                        });
                    }
                });
            });
        }
    }

    document.body.addEventListener('htmx:beforeRequest', function(event) {
        if (event.detail.elt.id !== 'scan-button' && event.detail.elt.id !== 'quick-scan-button' && event.detail.elt.id !== 'cover-scan-button') {
            Swal.fire({
                title: 'Cargando...',
                allowOutsideClick: false,
                showConfirmButton: false,
                didOpen: () => Swal.showLoading()
            });
        }
    });

    document.body.addEventListener('htmx:afterRequest', function(event) {
        Swal.close();
        if ((event.detail.elt.id === 'scan-button' || event.detail.elt.id === 'quick-scan-button' || event.detail.elt.id === 'cover-scan-button') && event.detail.xhr.status === 200) {
            const response = JSON.parse(event.detail.xhr.responseText);
            const taskId = response.task_id;
            if (taskId) pollTaskStatus(taskId);
        }
    });

    document.body.addEventListener('htmx:afterSwap', function() {
        updateUserMenuVisibility();
        initializeAccountButtonListener();
        initializeAvatarUpload();
        initializeSongMenuListeners();
        initializeCreatePlaylistButton();
        initializeUserMenuToggle();

        const audioPlayer = document.getElementById('main-audio-player');
        const songList = document.getElementById('song-list');
        if (audioPlayer && songList && !audioPlayer.paused) {
            songList.classList.add('playback-active');
        }
    });

    document.body.addEventListener('htmx:afterOnLoad', function() {
        updateUserMenuVisibility();
        initializeAccountButtonListener();
        initializeAvatarUpload();
        initializeSongMenuListeners();
        initializeCreatePlaylistButton();
        initializeUserMenuToggle();

        const audioPlayer = document.getElementById('main-audio-player');
        const songList = document.getElementById('song-list');
        if (audioPlayer && songList && !audioPlayer.paused) {
            songList.classList.add('playbook-active');
        }
    });

    function pollTaskStatus(taskId) {
        Swal.fire({
            title: 'Iniciando escaneo...',
            text: 'Por favor, espera.',
            allowOutsideClick: false,
            showConfirmButton: false,
            didOpen: () => Swal.showLoading()
        });

        const interval = setInterval(() => {
            fetch(`/task-status/${taskId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'PROGRESS') {
                        let title = 'Escaneando tu librería...';
                        let progressText = 'Preparando...';

                        if (data.info && data.info.step) {
                            if (data.info.step === 'finding_folders') {
                                title = 'Analizando estructura...';
                                progressText = 'Buscando todas las carpetas en tu nube. Esto puede tardar...';
                            } else if (data.info.step === 'folders_found') {
                                title = 'Análisis de estructura completo';
                                progressText = `Se encontraron ${data.info.total_folders} carpetas. Iniciando siguiente paso...`;
                            } else if (data.info.step === 'getting_existing_albums') {
                                title = 'Obteniendo álbumes existentes';
                                progressText = 'Identificando álbumes sin portada desde la base de datos...';
                            } else if (data.info.step === 'getting_existing_files') {
                                title = 'Obteniendo archivos existentes';
                                progressText = 'Consultando archivos ya registrados en la base de datos...';
                            } else if (data.info.step === 'searching_new_files') {
                                title = 'Buscando archivos nuevos';
                                progressText = 'Buscando archivos de audio no registrados...';
                            } else if (data.info.step === 'processing_new_files') {
                                title = 'Procesando archivos nuevos';
                                progressText = `Archivos procesados: ${data.info.current}`;
                            } else if (data.info.step === 'identifying_album_folders') {
                                title = 'Identificando Álbumes';
                                progressText = 'Determinando qué carpetas contienen música.';
                            } else if (data.info.step === 'songs') {
                                title = 'Paso 1 de 2: Procesando canciones...';
                                progressText = `Procesando lote ${data.info.current} de ${data.info.total}`;
                            } else if (data.info.step === 'covers') {
                                title = 'Buscando portadas...';
                                progressText = `Analizando carpeta de álbum ${data.info.current} de ${data.info.total}`;
                            }
                        }
                        Swal.update({ title, text: progressText });
                        Swal.showLoading();

                    } else if (data.status === 'SUCCESS') {
                        clearInterval(interval);
                        Swal.fire({
                            title: '¡Éxito!', text: data.info, icon: 'success', confirmButtonText: 'Ir a mi librería'
                        }).then(() => {
                            window.location.href = "{% url 'folder_browser' %}";
                        });
                    } else if (data.status === 'FAILURE') {
                        clearInterval(interval);
                        Swal.fire({
                            title: '¡Error!', text: 'Ocurrió un error durante el escaneo.', icon: 'error', confirmButtonText: 'Entendido'
                        });
                    }
                })
                .catch(error => {
                    clearInterval(interval);
                    Swal.fire('Error de conexión', 'No se pudo obtener el estado del escaneo.', 'error');
                });
        }, 3000);
    }

    window.showQueue = function() {
        console.log('Cola actual:', songQueue.map(song => song.name));
    };
    </script>
    {% endblock %}

</body>
</html>